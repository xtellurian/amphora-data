trigger:
  branches:
    include:
    - master
    - develop
  paths:
    exclude:
    - README.md
    - .gitignore
    - .vscode/*
    - pipeline/stack.destroy.pipeline.yaml


stages:

# - stage: branch
#   displayName: Branch Stage
#   variables:
#     stack: $(Build.SourceBranchName)
#   jobs:
#   - template: pipeline/infra.create.job.yaml
#     parameters:
#       jobName: infrastructure
#   - template: pipeline/app.test.job.yaml
#     parameters:
#       jobName: apps
#   - template: pipeline/app.deploy.job.yaml
#     parameters:
#       dependsOn: apps

- stage: deploy
  displayName: Deploy to Demo Envionment 
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
    - template: pipeline/deploymentjob.yaml
      parameters:
        jobName: demo_deploymentjob
        environment: demo

- stage: promote10
  displayName: Promote in Demo Envionment (10%)
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
    - template: pipeline/app.promote.deploymentjob.yaml
      parameters:
        jobName: demo_promotejob_10
        environment: develop
        percent: "10"
    - template: pipeline/app.promote.deploymentjob.yaml
      parameters:
        jobName: demo_promotejob_50
        environment: develop
        percent: "50"
    

- stage: swapslots
  displayName: Swap Slots in Demo Environment
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
    - template: pipeline/app.promote.deploymentjob.yaml
      parameters:
        jobName: demo_promotejob
        environment: develop
        percent: "50"