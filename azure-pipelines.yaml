trigger:
  branches:
    include:
    - master
    - develop
  paths:
    exclude:
    - README.md
    - .gitignore
    - .vscode/*
    - pipeline/stack.destroy.pipeline.yaml


stages:

# moved this upward for testing
# - stage: deploy
#   displayName: Deploy to Demo Envionment 
#   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
#   variables: 
#     stack: demo
#   jobs:
#     - template: pipeline/deploymentjob.yaml
#       parameters:
#         jobName: demo_deploymentjob
#         environment: demo

# moved this upward for testing
- stage: promote
  displayName: Deploy to Demo Envionment 
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  variables: 
    stack: demo
  jobs:
    - template: pipeline/app.promote.deploymentjob.yaml
      parameters:
        jobName: demo_promotejob
        environment: develop

- stage: branch
  displayName: Branch Stage
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master')) # remove me before PR
  variables:
    stack: $(Build.SourceBranchName)
  jobs:
  - template: pipeline/infra.create.job.yaml
    parameters:
      jobName: infrastructure
  - template: pipeline/app.test.job.yaml
    parameters:
      jobName: apps
  - template: pipeline/app.deploy.job.yaml
    parameters:
      dependsOn: apps