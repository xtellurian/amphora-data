trigger:
  branches:
    include:
      - master
      - develop
    exclude:
      - migrate/efcore
  paths:
    exclude:
    - README.md
    - .gitignore
    - .vscode/*
    - pipeline/stack.destroy.pipeline.yaml


stages:

- stage: branch
  displayName: Branch Stage
  variables:
    - name: stack
      value: $(Build.SourceBranchName)
    - group: AzureDeploySP
  jobs:
  - template: pipeline/infra.create.job.yaml
    parameters:
      jobName: infrastructure
  - template: pipeline/app.test.job.yaml
    parameters:
      jobName: apps
  - template: pipeline/app.deploy.job.yaml
    parameters:
      dependsOn: apps

- stage: deploy_master
  displayName: Deploy to Master Envionment 
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  variables:
    - group: AzureDeploySP
  jobs:
    - template: pipeline/deploymentjob.yaml
      parameters:
        jobName: master_deploymentjob
        environment: master
        staging: 'false'

- stage: deploy_prod
  displayName: Deploy to Prod Envionment 
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master')) 
  variables:
    - group: PulumiAzureDevOpsProd
  jobs:
    - template: pipeline/deploymentjob.yaml
      parameters:
        jobName: prod_deploymentjob
        environment: prod
        staging: 'true'

- stage: promote
  displayName: Promote in Prod Envionment (10%)
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master') )
  jobs:
    - job: init
      steps:
      - script: echo "Promoting in Prod"
      - template: checkversion.steps.yaml

    - template: pipeline/app.promote.deploymentjob.yaml
      parameters:
        dependsOn: init
        jobName: prod_promotejob_10
        environment: prod
        percent: "10"
    - job: delay1
      displayName: Delay
      pool: server
      dependsOn: prod_promotejob_10
      steps:
      - task: Delay@1
        inputs:
          delayForMinutes: '20' 
    - template: pipeline/app.slotswap.deploymentjob.yaml
      parameters:
        dependsOn: delay1
        jobName: prod_swapslots
        environment: prod

    