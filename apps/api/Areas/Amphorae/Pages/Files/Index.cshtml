@page
@model Files.IndexPageModel

@{
    ViewData["Title"] = Model.Amphora.Name + " Files";
}

@{
    var metadataModalIdDic = new Dictionary<string,string>();
    var filePreviewModalIdDic = new Dictionary<string,string>();
}
@foreach (var n in Model.Names)
{
    var metadataId = "A" + System.Guid.NewGuid().ToString();
    metadataModalIdDic[n] = metadataId;
    <div>
        @await Component.InvokeAsync("Metadata", new {id = metadataId, title = $"{n} Metadata", meta = Model.Amphora.FileAttributes?.GetValueOrDefault(n)})
    </div>
    @if(Amphora.Api.AspNet.ContentTypeRecogniser.IsImage(n))
    {
        var filePreviewId = "A" + System.Guid.NewGuid().ToString();
        filePreviewModalIdDic[n] = filePreviewId;
        <div>
            @await Component.InvokeAsync("FilePreview", new {id = filePreviewId, amphora = Model.Amphora, name = n, user = Model.Result.User})
        </div>
    }
}


<div class="container">
    <div class="row">
        <div class="col">
            <a asp-area="Amphorae" asp-page="/Detail/Index" asp-route-id="@Model.Amphora.Id"><button class="float-right btn btn-secondary m-1">Amphora</button></a>
            <h3>@Model.Amphora.Name</h3>
            <small>Files</small>
            <hr/>
        </div>
    </div>
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="container">
        @{var index = 0;}
        @foreach (var n in Model.Names)
        {
            var bg = "";
            if(index++ %2 == 1)
            {
                bg = "bg-light";
            }
            <div class="row m-2 @bg">
                <div class="col text-wrap">
                    @n
                </div>
                <div class="col-1 text-left">
                    @if(Amphora.Api.AspNet.ContentTypeRecogniser.IsImage(n))
                    {
                        <i class="text-primary fas fa-images" data-toggle="modal" data-target="#@filePreviewModalIdDic[n]"></i>
                    }
                </div>
                <div class="col-xl text-right">
                    @if(Model.CanDownloadFiles)
                    {
                        <a class="btn btn-primary btn-sm" asp-route-id="@Model.Amphora.Id" asp-route-name="@n" asp-page="@PageMap.FileDownload">
                            Download
                        </a>
                        <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#@metadataModalIdDic[n]">View Attributes</button>
                    }
                    @if(Model.CanUploadFiles)
                    {
                        <a class="btn btn-secondary btn-sm" asp-route-id="@Model.Amphora.Id" asp-route-name="@n" asp-page="./EditMetadata">
                            Edit Attributes
                        </a>
                    }
                    @if(Model.CanDeleteFiles)
                    {
                        <a class="btn btn-danger btn-sm" asp-route-id="@Model.Amphora.Id" asp-route-name="@n" asp-page="./Delete">
                            Delete
                        </a>
                    }
                </div>
            </div>
        }
    </div>
    @if(Model.CanUploadFiles)
    {
        <hr/>
        <div class="row">
            <div class="col">
                <h5 class="card-title">Upload File</h5>

                <form asp-route-id="@Model.Amphora.Id" asp-page-handler="upload" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <input class="form-control-file" type="file" name="files">
                        <small class="form-text card-text text-muted">This becomes content in the Amphora.</small>
                    </div>
                    <div class="form-group">
                        <input class="form-control" type="submit" value="Upload" data-toggle="collapse" href="#isUploading">
                    </div>
                </form> 
                <div id="isUploading" class="progress collapse">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%"></div>
                </div>                                        

            </div>
        </div>
    }
</div>
