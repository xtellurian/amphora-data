@page
@using Amphora.Common.Models.Permissions
@model Amphora.Api.Areas.Amphorae.Pages.DetailModel
@inject Amphora.Api.Services.FeatureFlags.FeatureFlagService FeatureFlags
@{
    ViewData["Title"] = Model.Amphora.Name;
}


<div id="main" class="container">
    <div class="row mb-3 border-bottom">
        <div class="col-9">
            <h2>@Model.Amphora.Name</h2>
        </div>
        <div class="col-3">
            <span>
                <a asp-page="./Index"><button class="btn btn-secondary">Amphorae</button></a>
            </span>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-4 mb-2">
            @{
            string iSrc = $"/Amphorae/StaticMap?id={Model.Amphora.Id}"; //The src path.
            }
            <img src="@Url.Content(iSrc)" class="img-fluid rounded mx-auto">
        </div>
        <div class="col-md-8">
            <div class="card bg-light">
                <div class="card-header">
                    by <a asp-page="/Profile/Detail" asp-route-id="@Model.Amphora.CreatedById">
                        @Model.Amphora.CreatedBy.FullName
                        </a> from
                        <a asp-page="/Organisations/Detail" asp-route-id="@Model.Amphora.CreatedBy.OrganisationId">
                        @Model.Amphora.CreatedBy.Organisation.Name
                        </a>
                    @if(Model.CanEditDetails)
                    {
                    <a asp-page="./Edit" asp-route-id="@Model.Amphora.Id"><i class="fas fa-edit ml-2"></i></a>
                    }
                    @{
                        var buttonMode = string.Empty;
                        var signalsButtonMode = string.Empty;
                        if(! Model.CanBuy) { buttonMode = "disabled"; } 
                        if(Model.CanBuy && !Model.CanUploadFiles) { signalsButtonMode = "disabled"; } 
                    }
                    <a asp-page="./Signals/Index" asp-route-id="@Model.Amphora.Id"><button class="btn btn-light" @signalsButtonMode>Signals</button></a>
                    <a asp-page="./Agreement" asp-route-id="@Model.Amphora.Id"><button class="btn btn-success" @buttonMode>Buy</button></a>
                </div>
                    <div class="card-body">
                        <h5 class="card-title">Description</h5>
                        <span class="card-text" style="white-space: pre-line">@Model.Amphora.Description</span>
                    </div>
                <div class="container card-footer">
                    <div class="row">
                        <div class="col-sm">
                            $@Model.Amphora.Price 
                        </div>
                        <div>
                            @if(Model.CanUploadFiles)
                            {    
                            <a class="m-1 float-left" data-toggle="collapse" href="#uploadFileCollapse" role="button" aria-expanded="false" aria-controls="collapseAdvanced">
                                <i class="fas fa-upload"></i>
                            </a>
                            }
                            @if(Model.CanEditPermissions)
                            {
                            <a class="m-1 float-left" data-toggle="collapse" href="#hasPurchasedCollapse" role="button" aria-expanded="false" aria-controls="collapseAdvanced">
                                <i class="fas fa-users"></i>
                            </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div id="uploadFileCollapse" class="card mt-2 collapse">
                <div class="card-header">
                    <h5 class="card-title">Upload File</h5>
                </div>
                <div class="card-body">
                    <div class="container">
                        <form method="post" enctype="multipart/form-data">
                            <div class="form-group">
                                <input class="form-control-file" type="file" name="files">
                                <small class="form-text card-text text-muted">This becomes content in the Amphora.</small>
                            </div>
                            <div class="form-group">
                                <input class="form-control" type="submit" value="Upload" data-toggle="collapse" href="#isUploading">
                            </div>
                        </form> 
                        <div id="isUploading" class="progress collapse">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%"></div>
                        </div>
                    </div>                                                        
                </div>
            </div>
            @if(Model.CanEditPermissions)
            {
            <div id="hasPurchasedCollapse" class="card bg-light mt-2 collapse">
                <div class="card-header">
                     <div>
                        <a class="float-right" asp-route-id="@Model.Amphora.Id" asp-page="./Invite">
                            <i class="fas fa-user-plus"></i>
                        </a>
                    </div>
                    <h5 class="card-title">Has Purchased</h5>
                </div>
                <ul class="list-group">
                @foreach (var a in Model.Purchases)
                {
                    var d = new Dictionary<string, string>{ {"userName", a.PurchasedByUserId} };
                    
                    <li> 
                        <i class="far fa-user mr-2" data-toggle="tooltip" data-placement="top" title="@a.PurchasedByUser.UserName"></i> 
                        <a asp-page="/Profile/Detail" asp-all-route-data=@d > @a.PurchasedByUser.UserName </a>
                    </li>
                }
                </ul>
            </div>
            }
            
        </div>
    </div>
    <div>
        <table id="file-table" class="table">
            <thead>
                <tr>
                <th scope="col">Filename</th>
                <th> Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var n in Model.Names)
                {
                <tr class="file-item">
                    <th scope="row">@n</th>
                    <td><a asp-route-id="@Model.Amphora.Id" asp-route-name="@n" asp-page="./File"><button class="btn btn-primary">Download</button></a></td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    

</div>

