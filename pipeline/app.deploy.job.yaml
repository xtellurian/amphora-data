
parameters:
  jobName: 'deploy'
  staging: 'false'

jobs:
- job: ${{ parameters.jobName }}
  displayName: Deploy App
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  dependsOn: 
    - infrastructure
    - apps
  pool:
    vmImage: 'Ubuntu-16.04'

  variables:
  - name: staging
    value: ${{ parameters.staging }}
  - name: pulumi.acrName
    value: $[ dependencies.infrastructure.outputs['pulumi.acrName'] ]
  - name: pulumi.webAppResourceId
    value: $[ dependencies.infrastructure.outputs['pulumi.webAppResourceId'] ]
  steps:
  - script: |
      echo acrName is $(acrName)
      echo webAppResourceId is $(webAppResourceId)
    displayName: Echo requirement variables.
  - template: app.deploy.steps.yaml
