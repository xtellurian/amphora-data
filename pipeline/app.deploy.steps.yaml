steps:
- script: |
    chmod +x ./infra/*.sh
    ./infra/setup.sh
    ./infra/pulumi-stack.sh
  displayName: 'Install pulumi & run pulumi up'
  name: pulumi
  env:
    PULUMI_ACCESS_TOKEN: $(PULUMI_ACCESS_TOKEN)
    STACK: $(stack) # will be overwritten in develop and master

- script: az login --service-principal -u $NAME -p $PASSWORD --tenant $TENANT
  displayName: Az Login
  env: 
    NAME: $(name)
    PASSWORD: $(password)
    TENANT: $(tenant)

- script: |
    chmod +x infra/deploy-app.sh
    ./infra/deploy-app.sh
  displayName: Build and Push Docker Image
  env:
    ACR_NAME: $(acrName)
    CONTEXT: $(Build.SourcesDirectory)/apps
    IMAGE: $(acrName).azurecr.io/webapp
    GITHASH: $(Build.SourceVersion)
    BUILD: $(Build.SourceBranchName)-$(Build.BuildNumber)
    WEBAPPID: $(webAppResourceId)
